<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™˜ë¶ˆ í˜„í™© ëŒ€ì‹œë³´ë“œ v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        * {
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="app" class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- ë¡œë”© í™”ë©´ -->
            <div id="loading" class="flex items-center justify-center min-h-screen">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-gray-300 mx-auto mb-4"></div>
                    <p class="text-gray-300 text-lg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

            <!-- ë©”ì¸ ì»¨í…ì¸  -->
            <div id="content" class="hidden">
                <!-- í—¤ë” -->
                <div class="mb-8">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <h1 class="text-4xl font-bold text-yellow-400 mb-2">Abyss of Dungeons í™˜ë¶ˆ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
                            <p class="text-gray-400">ì‹¤ì‹œê°„ í™˜ë¶ˆ ë°ì´í„° ë¶„ì„</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="date" id="startDate" class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm border border-gray-600 focus:outline-none focus:border-gray-500">
                                <span class="text-gray-400">~</span>
                                <input type="date" id="endDate" class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm border border-gray-600 focus:outline-none focus:border-gray-500">
                                <button onclick="loadData()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center gap-2">
                                    ğŸ”„ ìƒˆë¡œê³ ì¹¨
                                </button>
                            </div>
                            <p id="lastUpdated" class="text-sm text-gray-400"></p>
                        </div>
                    </div>
                </div>

                <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-gray-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm font-medium mb-1">ì´ í™˜ë¶ˆ ê±´ìˆ˜</p>
                                <p id="totalCount" class="text-4xl font-bold text-white">0</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-full">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-gray-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm font-medium mb-1">ì´ í™˜ë¶ˆ ê¸ˆì•¡</p>
                                <p id="totalAmount" class="text-4xl font-bold text-white">$0</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-full">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Storeë³„ ë¶„í¬ -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-white mb-4">Storeë³„ ë¶„í¬</h2>
                        <div id="storeChart"></div>
                    </div>

                    <!-- Languageë³„ ë¶„í¬ -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-white mb-4">Languageë³„ ë¶„í¬</h2>
                        <div id="languageChart"></div>
                    </div>
                </div>

                <!-- ë‚ ì§œë³„ ì¶”ì´ -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-white mb-4">ë‚ ì§œë³„ í™˜ë¶ˆ ê±´ìˆ˜ ì¶”ì´</h2>
                    <div id="dateChart"></div>
                </div>

                <!-- í‘¸í„° -->
                <footer class="mt-8 text-center py-4 border-t border-gray-700">
                    <p class="text-gray-400 text-sm">
                        Made by <span class="font-semibold text-gray-300">JEEYEA CHA</span>
                    </p>
                </footer>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzCQXMyI5PedL2ZnR3qyi0QB2EKpLSsocmkG3Edttpv00asb0iRUmRmKxj_QHw4VKC_/exec';
        let charts = {
            store: null,
            language: null,
            date: null
        };

        async function loadData() {
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
                
                let data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ë‚ ì§œ í•„í„°ë§
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate || endDate) {
                    data = data.filter(row => {
                        if (!row.date) return false;
                        const rowDate = row.date;
                        if (startDate && rowDate < startDate) return false;
                        if (endDate && rowDate > endDate) return false;
                        return true;
                    });
                }
                
                updateDashboard(data);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                document.getElementById('lastUpdated').textContent = 
                    `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="text-center bg-gray-800 p-8 rounded-xl shadow-lg max-w-md mx-auto">
                        <div class="text-red-400 text-5xl mb-4">âš ï¸</div>
                        <h2 class="text-2xl font-bold text-white mb-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                        <p class="text-gray-400 mb-4">${error.message}</p>
                        <button onclick="loadData()" class="bg-gray-700 text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition">
                            ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                `;
            }
        }

        function updateDashboard(data) {
            // companyê°€ ìˆìœ¼ë©´ ëª¨ë‘ ìœ íš¨í•œ ë°ì´í„°ë¡œ ì²˜ë¦¬
            const validData = data.filter(row => row.company);
            
            // ì´ ê±´ìˆ˜ëŠ” "í™˜ë¶ˆ ì™„ë£Œ/Refunded" ìƒíƒœì¸ ê²ƒë§Œ ì¹´ìš´íŠ¸
            const completedData = validData.filter(row => {
                const status = row.status || '';
                return status.includes('í™˜ë¶ˆ ì™„ë£Œ') || status.includes('Refunded');
            });
            const totalCount = completedData.length;
            
            // ì´ ê¸ˆì•¡
            const totalAmount = validData.reduce((sum, row) => {
                const amount = parseFloat(row.amount?.replace(/[^0-9.-]/g, '') || 0);
                return sum + amount;
            }, 0);

            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalAmount').textContent = 
                totalAmount > 0 ? `$${totalAmount.toLocaleString()}` : 'N/A';

            // Storeë³„ ë¶„í¬ (ì „ì²´ ë°ì´í„°)
            const storeDist = {};
            validData.forEach(row => {
                const store = row.store && row.store.trim() !== '' ? row.store : 'ë¯¸ì •';
                storeDist[store] = (storeDist[store] || 0) + 1;
            });
            updateStoreChart(storeDist);

            // Languageë³„ ë¶„í¬ (ì „ì²´ ë°ì´í„°)
            const languageDist = {};
            validData.forEach(row => {
                const language = row.language && row.language.trim() !== '' ? row.language : 'ë¯¸ì •';
                languageDist[language] = (languageDist[language] || 0) + 1;
            });
            updateLanguageChart(languageDist);

            // ë‚ ì§œë³„ ì¶”ì´ (í™˜ë¶ˆ ì™„ë£Œë§Œ)
            const dateDist = {};
            completedData.forEach(row => {
                const date = row.date;
                if (date && date !== 'â¡') {
                    dateDist[date] = (dateDist[date] || 0) + 1;
                }
            });
            updateDateChart(dateDist);
        }

        function updateStoreChart(data) {
            const labels = Object.keys(data);
            const values = Object.values(data);

            const options = {
                series: [{
                    name: 'í™˜ë¶ˆ ê±´ìˆ˜',
                    data: values
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    background: 'transparent',
                    foreColor: '#9ca3af'
                },
                plotOptions: {
                    bar: {
                        borderRadius: 6,
                        dataLabels: {
                            position: 'center',
                        },
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold',
                        colors: ["#ffffff"]
                    }
                },
                xaxis: {
                    categories: labels,
                    labels: {
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.floor(val);
                        },
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                grid: {
                    borderColor: '#374151'
                },
                colors: ['#8b5cf6']
            };

            if (charts.store) {
                charts.store.destroy();
            }
            charts.store = new ApexCharts(document.querySelector("#storeChart"), options);
            charts.store.render();
        }

        function updateLanguageChart(data) {
            const labels = Object.keys(data);
            const values = Object.values(data);

            const options = {
                series: [{
                    name: 'í™˜ë¶ˆ ê±´ìˆ˜',
                    data: values
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    background: 'transparent',
                    foreColor: '#9ca3af'
                },
                plotOptions: {
                    bar: {
                        borderRadius: 6,
                        dataLabels: {
                            position: 'center',
                        },
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold',
                        colors: ["#ffffff"]
                    }
                },
                xaxis: {
                    categories: labels,
                    labels: {
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.floor(val);
                        },
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                grid: {
                    borderColor: '#374151'
                },
                colors: ['#14b8a6']
            };

            if (charts.language) {
                charts.language.destroy();
            }
            charts.language = new ApexCharts(document.querySelector("#languageChart"), options);
            charts.language.render();
        }

        function updateDateChart(data) {
            // ë‚ ì§œë³„ ì¹´ìš´íŠ¸ ë§µ ìƒì„±
            const dateMap = {};
            Object.entries(data).forEach(([date, count]) => {
                dateMap[date] = count;
            });
            
            // ë‚ ì§œ ë²”ìœ„ ì„¤ì •
            let allDates = [];
            const dates = Object.keys(dateMap).sort();
            
            if (dates.length > 0) {
                // ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ì„¤ì •
                const startDate = new Date(dates[0]);
                const endDate = new Date(dates[dates.length - 1]);
                
                // ì¢…ë£Œì¼ì„ ì˜¤ëŠ˜ ë‚ ì§œì™€ ë¹„êµí•´ì„œ ë” ìµœê·¼ ë‚ ì§œë¡œ ì„¤ì •
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const finalEndDate = endDate > today ? endDate : today;
                
                // ì‹œì‘ì¼ë¶€í„° ì¢…ë£Œì¼(ë˜ëŠ” ì˜¤ëŠ˜)ê¹Œì§€ ëª¨ë“  ë‚ ì§œ ìƒì„±
                for (let d = new Date(startDate); d <= finalEndDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    allDates.push(dateStr);
                }
            } else {
                // ë°ì´í„°ê°€ ì—†ì„ ë•ŒëŠ” ì˜¤ëŠ˜ ë‚ ì§œë§Œ í‘œì‹œ
                const today = new Date();
                allDates.push(today.toISOString().split('T')[0]);
            }
            
            // ëª¨ë“  ë‚ ì§œì— ëŒ€í•´ ê°’ ì„¤ì • (ì—†ìœ¼ë©´ 0)
            const labels = allDates;
            const values = allDates.map(date => dateMap[date] || 0);

            const options = {
                series: [{
                    name: 'í™˜ë¶ˆ ê±´ìˆ˜',
                    data: values
                }],
                chart: {
                    type: 'area',
                    height: 300,
                    background: 'transparent',
                    foreColor: '#9ca3af',
                    zoom: {
                        enabled: false
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '11px',
                        fontWeight: 'bold',
                        colors: ['#06b6d4']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#1f2937',
                        borderRadius: 2,
                        padding: 4,
                        opacity: 0.9,
                        borderWidth: 1,
                        borderColor: '#06b6d4'
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                xaxis: {
                    categories: labels,
                    labels: {
                        rotate: -45,
                        rotateAlways: true,
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.floor(val);
                        },
                        style: {
                            colors: '#9ca3af'
                        }
                    },
                    min: 0
                },
                grid: {
                    borderColor: '#374151'
                },
                colors: ['#06b6d4'],
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.2,
                    }
                }
            };

            if (charts.date) {
                charts.date.destroy();
            }
            charts.date = new ApexCharts(document.querySelector("#dateChart"), options);
            charts.date.render();
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadData();
    </script>
</body>
</html>