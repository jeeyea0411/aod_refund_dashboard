<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOD í™˜ë¶ˆ í˜„í™© ëŒ€ì‹œë³´ë“œ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        * {
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="app" class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- ë¡œë”© í™”ë©´ -->
            <div id="loading" class="flex items-center justify-center min-h-screen">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-gray-300 mx-auto mb-4"></div>
                    <p class="text-gray-300 text-lg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

            <!-- ë©”ì¸ ì»¨í…ì¸  -->
            <div id="content" class="hidden">
                <!-- í—¤ë” -->
                <div class="mb-8">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <h1 class="text-4xl font-bold text-yellow-400 mb-2" style="text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8), 6px 6px 12px rgba(0, 0, 0, 0.5);">Abyss of Dungeons í™˜ë¶ˆ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
                            <p class="text-gray-400">ì‹¤ì‹œê°„ í™˜ë¶ˆ ë°ì´í„° ë¶„ì„</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2 mb-2 flex-wrap justify-end">
                                <div class="relative">
                                    <input type="date" id="startDate" class="bg-gray-700 text-white px-3 py-2 pr-8 rounded-lg text-sm border border-gray-600 focus:outline-none focus:border-gray-500">
                                    <button onclick="clearStartDate()" id="clearStartBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white hidden">
                                        âœ•
                                    </button>
                                </div>
                                <span class="text-gray-400">~</span>
                                <div class="relative">
                                    <input type="date" id="endDate" class="bg-gray-700 text-white px-3 py-2 pr-8 rounded-lg text-sm border border-gray-600 focus:outline-none focus:border-gray-500">
                                    <button onclick="clearEndDate()" id="clearEndBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white hidden">
                                        âœ•
                                    </button>
                                </div>
                                <button id="applyBtn" onclick="applyFilter()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                    <span id="applyBtnText">âœ“ ì ìš©</span>
                                </button>
                                <button id="resetBtn" onclick="resetDates()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center gap-2">
                                    <span id="resetBtnText">ğŸ”„ ì „ì²´</span>
                                </button>
                            </div>
                            <p id="lastUpdated" class="text-sm text-gray-400"></p>
                        </div>
                    </div>
                </div>

                <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm font-medium mb-1">ì´ í™˜ë¶ˆ ê±´ìˆ˜</p>
                                <p id="totalCount" class="text-4xl font-bold text-white">0</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-full">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm font-medium mb-1">ì´ í™˜ë¶ˆ ê¸ˆì•¡</p>
                                <p id="totalAmount" class="text-4xl font-bold text-white">$0</p>
                                <p id="totalAmountKRW" class="text-sm text-gray-400 mt-1"></p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-full">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-yellow-400">
                        <p class="text-gray-400 text-sm font-medium mb-3">í˜„ì¬ í™˜ë¶ˆ ìƒíƒœ</p>
                        <div id="statusSummary" class="space-y-2">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                        </div>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- ìŠ¤í† ì–´ë³„ ë¶„í¬ -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-white mb-4">ìŠ¤í† ì–´ë³„ ë¶„í¬</h2>
                        <div id="storeChart"></div>
                    </div>

                    <!-- ì–¸ì–´ë³„ ë¶„í¬ -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-white mb-4">ì–¸ì–´ë³„ ë¶„í¬</h2>
                        <div id="languageChart"></div>
                    </div>
                </div>

                <!-- ìŠ¤í† ì–´ë³„ í™˜ë¶ˆ ê¸ˆì•¡ -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-bold text-white mb-4">ìŠ¤í† ì–´ë³„ í™˜ë¶ˆ ê¸ˆì•¡ (ë‚ ì§œë³„)</h2>
                    <div id="storeAmountChart"></div>
                </div>

                <!-- ë‚ ì§œë³„ ì¶”ì´ -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-white mb-4">ë‚ ì§œë³„ í™˜ë¶ˆ ê±´ìˆ˜ ì¶”ì´</h2>
                    <div id="dateChart"></div>
                </div>

                <!-- í‘¸í„° -->
                <footer class="mt-8 text-center py-4 border-t border-gray-700">
                    <p class="text-gray-400 text-sm">
                        Made by <span class="font-semibold text-gray-300">JEEYEA CHA</span>
                    </p>
                </footer>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzCQXMyI5PedL2ZnR3qyi0QB2EKpLSsocmkG3Edttpv00asb0iRUmRmKxj_QHw4VKC_/exec';
        let charts = {
            store: null,
            language: null,
            storeAmount: null,
            date: null
        };

        let isLoading = false;

        // ë‚ ì§œ ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const clearStartBtn = document.getElementById('clearStartBtn');
            const clearEndBtn = document.getElementById('clearEndBtn');
            
            startDateInput.addEventListener('input', function() {
                clearStartBtn.classList.toggle('hidden', !this.value);
            });
            
            endDateInput.addEventListener('input', function() {
                clearEndBtn.classList.toggle('hidden', !this.value);
            });
        });

        // ì‹œì‘ì¼ ì‚­ì œ
        function clearStartDate() {
            document.getElementById('startDate').value = '';
            document.getElementById('clearStartBtn').classList.add('hidden');
        }

        // ì¢…ë£Œì¼ ì‚­ì œ
        function clearEndDate() {
            document.getElementById('endDate').value = '';
            document.getElementById('clearEndBtn').classList.add('hidden');
        }

        async function loadData() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
                
                let data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ë‚ ì§œ í•„í„°ë§
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate || endDate) {
                    data = data.filter(row => {
                        if (!row.date) return false;
                        const rowDate = row.date;
                        if (startDate && rowDate < startDate) return false;
                        if (endDate && rowDate > endDate) return false;
                        return true;
                    });
                }
                
                updateDashboard(data);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                document.getElementById('lastUpdated').textContent = 
                    `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;
                isLoading = false;
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="text-center bg-gray-800 p-8 rounded-xl shadow-lg max-w-md mx-auto">
                        <div class="text-red-400 text-5xl mb-4">âš ï¸</div>
                        <h2 class="text-2xl font-bold text-white mb-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                        <p class="text-gray-400 mb-4">${error.message}</p>
                        <button onclick="loadData()" class="bg-gray-700 text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition">
                            ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                `;
                isLoading = false;
            }
        }

        function updateDashboard(data) {
            // companyê°€ ìˆìœ¼ë©´ ëª¨ë‘ ìœ íš¨í•œ ë°ì´í„°ë¡œ ì²˜ë¦¬
            const validData = data.filter(row => row.company);
            
            // ì´ ê±´ìˆ˜ëŠ” "í™˜ë¶ˆ ì™„ë£Œ/Refunded" ìƒíƒœì¸ ê²ƒë§Œ ì¹´ìš´íŠ¸
            const completedData = validData.filter(row => {
                const status = row.status || '';
                return status.includes('í™˜ë¶ˆ ì™„ë£Œ') || status.includes('Refunded');
            });
            const totalCount = completedData.length;
            
            // ì´ ê¸ˆì•¡
            const totalAmount = validData.reduce((sum, row) => {
                const amount = parseFloat(row.amount?.replace(/[^0-9.-]/g, '') || 0);
                return sum + amount;
            }, 0);

            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalAmount').textContent = 
                totalAmount > 0 ? `$${totalAmount.toLocaleString()}` : 'N/A';
            
            // ì›í™” í™˜ì‚° (í™˜ìœ¨: 1 USD = 1400 KRW)
            if (totalAmount > 0) {
                const krwAmount = Math.round(totalAmount * 1400);
                document.getElementById('totalAmountKRW').textContent = `ì•½ ${krwAmount.toLocaleString()}ì›`;
            } else {
                document.getElementById('totalAmountKRW').textContent = '';
            }

            // í™˜ë¶ˆ ìƒíƒœ ìš”ì•½ (í•œêµ­ì–´ë§Œ)
            const statusDist = {};
            validData.forEach(row => {
                const status = row.status || 'ë¯¸í™•ì¸';
                // í•œêµ­ì–´ ë¶€ë¶„ë§Œ ì¶”ì¶œ
                const koreanStatus = status.split('/')[0].trim() || 'ë¯¸í™•ì¸';
                statusDist[koreanStatus] = (statusDist[koreanStatus] || 0) + 1;
            });
            updateStatusSummary(statusDist);

            // Storeë³„ ë¶„í¬ (ì „ì²´ ë°ì´í„°)
            const storeDist = {};
            validData.forEach(row => {
                const store = row.store && row.store.trim() !== '' ? row.store : 'ë¯¸ì •';
                storeDist[store] = (storeDist[store] || 0) + 1;
            });
            updateStoreChart(storeDist);

            // Storeë³„ ë‚ ì§œë³„ í™˜ë¶ˆ ê¸ˆì•¡ ì§‘ê³„
            console.log('Valid data length:', validData.length);
            console.log('First 3 items:', validData.slice(0, 3));
            
            const storeAmountByDate = {};
            validData.forEach((row, index) => {
                const store = row.store && row.store.trim() !== '' ? row.store : 'ë¯¸ì •';
                const date = row.date;
                const amountStr = row.amount;
                
                // amountê°€ ë¹„ì–´ìˆê±°ë‚˜ nullì´ë©´ 0
                let amount = 0;
                if (amountStr && amountStr.trim() !== '') {
                    amount = parseFloat(amountStr.toString().replace(/[^0-9.-]/g, '')) || 0;
                }
                
                if (index < 3) {
                    console.log(`Row ${index}:`, { 
                        store, 
                        date, 
                        amountStr, 
                        amount,
                        hasDate: !!date,
                        dateValid: date && date !== 'â¡'
                    });
                }
                
                if (date && date !== 'â¡') {
                    if (!storeAmountByDate[store]) {
                        storeAmountByDate[store] = {};
                    }
                    storeAmountByDate[store][date] = (storeAmountByDate[store][date] || 0) + amount;
                }
            });
            console.log('Store Amount By Date:', JSON.stringify(storeAmountByDate, null, 2));
            
            // ë¹ˆ ê°ì²´ ì²´í¬
            if (Object.keys(storeAmountByDate).length === 0) {
                console.error('No store amount data available!');
            }
            
            updateStoreAmountChart(storeAmountByDate);

            // Languageë³„ ë¶„í¬ (ì „ì²´ ë°ì´í„°)
            const languageDist = {};
            validData.forEach(row => {
                const language = row.language && row.language.trim() !== '' ? row.language : 'ë¯¸ì •';
                languageDist[language] = (languageDist[language] || 0) + 1;
            });
            updateLanguageChart(languageDist);

            // ë‚ ì§œë³„ ì¶”ì´ (í™˜ë¶ˆ ì™„ë£Œë§Œ)
            const dateDist = {};
            completedData.forEach(row => {
                const date = row.date;
                if (date && date !== 'â¡') {
                    dateDist[date] = (dateDist[date] || 0) + 1;
                }
            });
            updateDateChart(dateDist);
        }

        function updateStatusSummary(data) {
            const statusColors = {
                'í™•ì¸ ì¤‘': 'bg-yellow-500',
                'í™˜ë¶ˆ ì™„ë£Œ': 'bg-green-500',
                'ë³´ë¥˜': 'bg-orange-500',
                'í™˜ë¶ˆ ë¶ˆê°€': 'bg-red-500',
                'ìœ ì € ì•ˆë‚´ í•„ìš”': 'bg-purple-500',
                'ë¯¸í™•ì¸': 'bg-gray-500'
            };

            const container = document.getElementById('statusSummary');
            const sortedStatuses = Object.entries(data).sort((a, b) => b[1] - a[1]);
            
            container.innerHTML = sortedStatuses.map(([status, count]) => {
                const colorClass = statusColors[status] || 'bg-gray-500';
                return `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full ${colorClass}"></div>
                            <span class="text-gray-300 text-sm">${status}</span>
                        </div>
                        <span class="text-white font-semibold">${count}</span>
                    </div>
                `;
            }).join('');
        }

        function updateStoreAmountChart(storeData) {
            console.log('updateStoreAmountChart called with:', JSON.stringify(storeData, null, 2));
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ì°¨íŠ¸ í‘œì‹œ
            if (!storeData || Object.keys(storeData).length === 0) {
                console.warn('No store amount data to display');
                if (charts.storeAmount) {
                    charts.storeAmount.destroy();
                    charts.storeAmount = null;
                }
                return;
            }
            
            // ëª¨ë“  ë‚ ì§œ ìˆ˜ì§‘
            const allDatesSet = new Set();
            Object.entries(storeData).forEach(([store, dateAmounts]) => {
                Object.keys(dateAmounts).forEach(date => {
                    allDatesSet.add(date);
                });
            });
            
            const allDates = Array.from(allDatesSet).sort();
            console.log('All dates:', allDates);
            
            // ë‚ ì§œ ë²”ìœ„ ì±„ìš°ê¸° (ì‹œì‘ì¼ë¶€í„° ì˜¤ëŠ˜ê¹Œì§€)
            let filledDates = [];
            if (allDates.length > 0) {
                const firstDateParts = allDates[0].split('-');
                const startDate = new Date(
                    parseInt(firstDateParts[0]), 
                    parseInt(firstDateParts[1]) - 1, 
                    parseInt(firstDateParts[2])
                );
                
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                
                console.log('Start date:', allDates[0], 'Today:', todayStr);
                
                const currentDate = new Date(startDate);
                while (true) {
                    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    filledDates.push(dateStr);
                    
                    if (dateStr === todayStr) break;
                    currentDate.setDate(currentDate.getDate() + 1);
                    
                    // ë¬´í•œ ë£¨í”„ ë°©ì§€
                    if (filledDates.length > 365) break;
                }
            }
            
            console.log('Filled dates:', filledDates);
            
            // ìŠ¤í† ì–´ë³„ ì‹œë¦¬ì¦ˆ ìƒì„±
            const storeColors = {
                'Apple': '#8b5cf6',
                'Google': '#14b8a6',
                'ë¯¸ì •': '#9ca3af'
            };
            
            const series = Object.entries(storeData).map(([store, dateAmounts]) => {
                const data = filledDates.map(date => {
                    const value = dateAmounts[date] || 0;
                    return value;
                });
                console.log(`Series for ${store}:`, data);
                return {
                    name: store,
                    data: data
                };
            });
            
            console.log('Final series:', series);
            
            const colors = Object.keys(storeData).map(store => storeColors[store] || '#9ca3af');

            const options = {
                series: series,
                chart: {
                    type: 'line',
                    height: 300,
                    background: 'transparent',
                    foreColor: '#9ca3af',
                    zoom: {
                        enabled: false
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: filledDates,
                    labels: {
                        rotate: -45,
                        rotateAlways: true,
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return '$' + Math.floor(val);
                        },
                        style: {
                            colors: '#9ca3af'
                        }
                    },
                    min: 0
                },
                grid: {
                    borderColor: '#374151'
                },
                colors: colors,
                legend: {
                    show: true,
                    position: 'top',
                    labels: {
                        colors: '#9ca3af'
                    }
                },
                dataLabels: {
                    enabled: false
                }
            };

            if (charts.storeAmount) {
                charts.storeAmount.destroy();
            }
            
            charts.storeAmount = new ApexCharts(document.querySelector("#storeAmountChart"), options);
            charts.storeAmount.render();
            console.log('Chart rendered successfully');
        }

        function updateStoreChart(data) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            // í•­ëª©ë³„ ë‹¤ë¥¸ ìƒ‰ìƒ ë°°ì—´
            const colors = ['#8b5cf6', '#14b8a6', '#f59e0b', '#ef4444', '#06b6d4', '#10b981'];

            const options = {
                series: [{
                    name: 'í™˜ë¶ˆ ê±´ìˆ˜',
                    data: values
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    background: 'transparent',
                    foreColor: '#9ca3af'
                },
                plotOptions: {
                    bar: {
                        borderRadius: 6,
                        distributed: true,
                        dataLabels: {
                            position: 'center',
                        },
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold',
                        colors: ["#ffffff"]
                    }
                },
                xaxis: {
                    categories: labels,
                    labels: {
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.floor(val);
                        },
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                grid: {
                    borderColor: '#374151'
                },
                colors: colors,
                legend: {
                    show: false
                }
            };

            if (charts.store) {
                charts.store.destroy();
            }
            charts.store = new ApexCharts(document.querySelector("#storeChart"), options);
            charts.store.render();
        }

        function updateLanguageChart(data) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            // í•­ëª©ë³„ ë‹¤ë¥¸ ìƒ‰ìƒ ë°°ì—´
            const colors = ['#14b8a6', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4', '#10b981'];

            const options = {
                series: [{
                    name: 'í™˜ë¶ˆ ê±´ìˆ˜',
                    data: values
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    background: 'transparent',
                    foreColor: '#9ca3af'
                },
                plotOptions: {
                    bar: {
                        borderRadius: 6,
                        distributed: true,
                        dataLabels: {
                            position: 'center',
                        },
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold',
                        colors: ["#ffffff"]
                    }
                },
                xaxis: {
                    categories: labels,
                    labels: {
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.floor(val);
                        },
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                grid: {
                    borderColor: '#374151'
                },
                colors: colors,
                legend: {
                    show: false
                }
            };

            if (charts.language) {
                charts.language.destroy();
            }
            charts.language = new ApexCharts(document.querySelector("#languageChart"), options);
            charts.language.render();
        }

        function updateDateChart(data) {
            // ë‚ ì§œë³„ ì¹´ìš´íŠ¸ ë§µ ìƒì„±
            const dateMap = {};
            Object.entries(data).forEach(([date, count]) => {
                dateMap[date] = count;
            });
            
            // ë‚ ì§œ ë²”ìœ„ ì„¤ì •
            let allDates = [];
            const dates = Object.keys(dateMap).sort();
            
            if (dates.length > 0) {
                // ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ì„¤ì •
                const startDate = new Date(dates[0]);
                const endDate = new Date(dates[dates.length - 1]);
                
                // ì¢…ë£Œì¼ì„ ì˜¤ëŠ˜ ë‚ ì§œì™€ ë¹„êµí•´ì„œ ë” ìµœê·¼ ë‚ ì§œë¡œ ì„¤ì •
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const finalEndDate = endDate > today ? endDate : today;
                
                // ì‹œì‘ì¼ë¶€í„° ì¢…ë£Œì¼(ë˜ëŠ” ì˜¤ëŠ˜)ê¹Œì§€ ëª¨ë“  ë‚ ì§œ ìƒì„±
                for (let d = new Date(startDate); d <= finalEndDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    allDates.push(dateStr);
                }
            } else {
                // ë°ì´í„°ê°€ ì—†ì„ ë•ŒëŠ” ì˜¤ëŠ˜ ë‚ ì§œë§Œ í‘œì‹œ
                const today = new Date();
                allDates.push(today.toISOString().split('T')[0]);
            }
            
            // ëª¨ë“  ë‚ ì§œì— ëŒ€í•´ ê°’ ì„¤ì • (ì—†ìœ¼ë©´ 0)
            const labels = allDates;
            const values = allDates.map(date => dateMap[date] || 0);

            const options = {
                series: [{
                    name: 'í™˜ë¶ˆ ê±´ìˆ˜',
                    data: values
                }],
                chart: {
                    type: 'area',
                    height: 300,
                    background: 'transparent',
                    foreColor: '#9ca3af',
                    zoom: {
                        enabled: false
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '11px',
                        fontWeight: 'bold',
                        colors: ['#06b6d4']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#1f2937',
                        borderRadius: 2,
                        padding: 4,
                        opacity: 0.9,
                        borderWidth: 1,
                        borderColor: '#06b6d4'
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                xaxis: {
                    categories: labels,
                    labels: {
                        rotate: -45,
                        rotateAlways: true,
                        style: {
                            colors: '#9ca3af'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.floor(val);
                        },
                        style: {
                            colors: '#9ca3af'
                        }
                    },
                    min: 0
                },
                grid: {
                    borderColor: '#374151'
                },
                colors: ['#06b6d4'],
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.2,
                    }
                }
            };

            if (charts.date) {
                charts.date.destroy();
            }
            charts.date = new ApexCharts(document.querySelector("#dateChart"), options);
            charts.date.render();
        }

        // ë‚ ì§œ í•„í„° ì ìš©
        function applyFilter() {
            const applyBtn = document.getElementById('applyBtn');
            const applyBtnText = document.getElementById('applyBtnText');
            
            applyBtnText.innerHTML = '<span class="inline-block animate-spin mr-1">â³</span> ë¡œë”©ì¤‘...';
            applyBtn.disabled = true;
            applyBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            loadData().finally(() => {
                applyBtnText.textContent = 'âœ“ ì ìš©';
                applyBtn.disabled = false;
                applyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }

        // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
        function resetDates() {
            const resetBtn = document.getElementById('resetBtn');
            const resetBtnText = document.getElementById('resetBtnText');
            
            resetBtnText.innerHTML = '<span class="inline-block animate-spin mr-1">â³</span> ë¡œë”©ì¤‘...';
            resetBtn.disabled = true;
            resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            loadData().finally(() => {
                resetBtnText.textContent = 'ğŸ”„ ì „ì²´';
                resetBtn.disabled = false;
                resetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadData();
    </script>
</body>
</html>